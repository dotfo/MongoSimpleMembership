<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>MongoSimpleMembership by lyphtec</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/lyphtec/MongoSimpleMembership">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/lyphtec/MongoSimpleMembership/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/lyphtec/MongoSimpleMembership/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>MongoSimpleMembership</h1>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/lyphtec">lyphtec</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h1>SimpleMembership providers using MongoDB as the backing store</h1>

<p>This this a SimpleMembership implementation using MongoDB as the backing store that provides a custom Membership provider (ExtendedMembershipProvider to be exact) and Role provider.</p>

<p>For more information about SimpleMembership see this post by Jon Galloway : <a href="http://weblogs.asp.net/jgalloway/archive/2012/08/29/simplemembership-membership-providers-universal-providers-and-the-new-asp-net-4-5-web-forms-and-asp-net-mvc-4-templates.aspx">SimpleMembership, Membership Providers, Universal Providers and the new ASP.NET 4.5 Web Forms and ASP.NET MVC 4 templates</a></p>

<h2>Installation</h2>

<p>Available on <a href="http://nuget.org/packages/LyphTEC.MongoSimpleMembership/">NuGet</a>:</p>

<pre><code>PM&gt; Install-Package LyphTEC.MongoSimpleMembership
</code></pre>

<h2>Required changes</h2>

<p>You must complete the following steps after you have installed the NuGet package before your app will run:</p>

<ol>
<li>
<p>Configure your data connection string to the MongoDB database</p>

<p>eg.</p>

<div class="highlight"><pre>  <span class="nt">&lt;connectionStrings&gt;</span>
    <span class="nt">&lt;clear/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"MongoSimpleMembership"</span> <span class="na">connectionString=</span><span class="s">"mongodb://localhost/SimpleMembership?safe=true"</span>  <span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>
</pre></div>

<p>Note that the connection string must also include the database name. In the example above, this will use the database named "SimpleMembership".   </p>
</li>
<li>
<p>Update the system.web/membership &amp; system.web/roleManager sections to use the connection string name as defined above</p>

<p>Also make sure that the "defaultProvider" attributes are set to use the matching MongoSimpleMembership provider names.</p>

<p>eg.</p>

<div class="highlight"><pre>  <span class="nt">&lt;membership</span> <span class="na">defaultProvider=</span><span class="s">"MongoSimpleMembershipProvider"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;providers&gt;</span>
      <span class="nt">&lt;clear</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"MongoSimpleMembershipProvider"</span> <span class="na">type=</span><span class="s">"LyphTEC.MongoSimpleMembership.MongoSimpleMembershipProvider, LyphTEC.MongoSimpleMembership"</span> <span class="na">connectionStringName=</span><span class="s">"MongoSimpleMembership"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/providers&gt;</span>
  <span class="nt">&lt;/membership&gt;</span>

  <span class="nt">&lt;roleManager</span> <span class="na">enabled=</span><span class="s">"true"</span> <span class="na">defaultProvider=</span><span class="s">"MongoRoleProvider"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;providers&gt;</span>
      <span class="nt">&lt;clear</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"MongoRoleProvider"</span> <span class="na">type=</span><span class="s">"LyphTEC.MongoSimpleMembership.MongoRoleProvider, LyphTEC.MongoSimpleMembership"</span> <span class="na">connectionStringName=</span><span class="s">"MongoSimpleMembership"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/providers&gt;</span>
  <span class="nt">&lt;/roleManager&gt;</span>
</pre></div>
</li>
<li><p>If you are using the default "ASP.NET MVC4 Internet" template. You must make some changes to AccountController:</p></li>
</ol><ul>
<li><p>Remove the [InitializeSimpleMembership] attribute (this is the ActionFilterAttribute defined in Filters/InitializeSimpleMembershipAttribute.cs).
This used by the default SimpleMembershipProvider that needs to initialize the SQL Server.
Since we are not using SQL Server, this is no longer required.</p></li>
<li>
<p>Make changes to the ExternalLoginConfirmation() method to remove Entity Framework related hooks used by the default SimpleMembershipProvider.</p>

<p>Here's what it looks like before the change: </p>

<div class="highlight"><pre><span class="na">[HttpPost]</span>
<span class="na">[AllowAnonymous]</span>
<span class="na">[ValidateAntiForgeryToken]</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">ExternalLoginConfirmation</span><span class="p">(</span><span class="n">RegisterExternalLoginModel</span> <span class="n">model</span><span class="p">,</span> <span class="kt">string</span> <span class="n">returnUrl</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">provider</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">providerUserId</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span> <span class="p">||</span> <span class="p">!</span><span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">TryDeserializeProviderUserId</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ExternalLoginData</span><span class="p">,</span> <span class="k">out</span> <span class="n">provider</span><span class="p">,</span> <span class="k">out</span> <span class="n">providerUserId</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"Manage"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Insert a new user into the database</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">UsersContext</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UsersContext</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">UserProfile</span> <span class="n">user</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">UserProfiles</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">UserName</span><span class="p">.</span><span class="n">ToLower</span><span class="p">()</span> <span class="p">==</span> <span class="n">model</span><span class="p">.</span><span class="n">UserName</span><span class="p">.</span><span class="n">ToLower</span><span class="p">());</span>
            <span class="c1">// Check if user already exists</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Insert name into the profile table</span>
                <span class="n">db</span><span class="p">.</span><span class="n">UserProfiles</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">UserProfile</span> <span class="p">{</span> <span class="n">UserName</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">UserName</span> <span class="p">});</span>
                <span class="n">db</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>

                <span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">CreateOrUpdateAccount</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">providerUserId</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">UserName</span><span class="p">);</span>
                <span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">Login</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">providerUserId</span><span class="p">,</span> <span class="n">createPersistentCookie</span><span class="p">:</span> <span class="k">false</span><span class="p">);</span>

                <span class="k">return</span> <span class="nf">RedirectToLocal</span><span class="p">(</span><span class="n">returnUrl</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">ModelState</span><span class="p">.</span><span class="n">AddModelError</span><span class="p">(</span><span class="s">"UserName"</span><span class="p">,</span> <span class="s">"User name already exists. Please enter a different user name."</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">ViewBag</span><span class="p">.</span><span class="n">ProviderDisplayName</span> <span class="p">=</span> <span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">GetOAuthClientData</span><span class="p">(</span><span class="n">provider</span><span class="p">).</span><span class="n">DisplayName</span><span class="p">;</span>
    <span class="n">ViewBag</span><span class="p">.</span><span class="n">ReturnUrl</span> <span class="p">=</span> <span class="n">returnUrl</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>And here's what it should look like after the change:   </p>

<div class="highlight"><pre><span class="na">    [HttpPost]</span>
<span class="na">    [AllowAnonymous]</span>
<span class="na">    [ValidateAntiForgeryToken]</span>
    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">ExternalLoginConfirmation</span><span class="p">(</span><span class="n">RegisterExternalLoginModel</span> <span class="n">model</span><span class="p">,</span> <span class="kt">string</span> <span class="n">returnUrl</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">provider</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">providerUserId</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span> <span class="p">||</span> <span class="p">!</span><span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">TryDeserializeProviderUserId</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">ExternalLoginData</span><span class="p">,</span> <span class="k">out</span> <span class="n">provider</span><span class="p">,</span> <span class="k">out</span> <span class="n">providerUserId</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"Manage"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">userId</span> <span class="p">=</span> <span class="n">WebSecurity</span><span class="p">.</span><span class="n">GetUserId</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">UserName</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">userId</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// TODO : Add custom user profile logic here</span>

                <span class="c1">// this will create a non-local account</span>
                <span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">CreateOrUpdateAccount</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">providerUserId</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">UserName</span><span class="p">);</span>
                <span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">Login</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">providerUserId</span><span class="p">,</span> <span class="n">createPersistentCookie</span><span class="p">:</span> <span class="k">false</span><span class="p">);</span>

                <span class="k">return</span> <span class="nf">RedirectToLocal</span><span class="p">(</span><span class="n">returnUrl</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">ModelState</span><span class="p">.</span><span class="n">AddModelError</span><span class="p">(</span><span class="s">"UserName"</span><span class="p">,</span> <span class="s">"User name already exists. Please enter a different user name."</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ViewBag</span><span class="p">.</span><span class="n">ProviderDisplayName</span> <span class="p">=</span> <span class="n">OAuthWebSecurity</span><span class="p">.</span><span class="n">GetOAuthClientData</span><span class="p">(</span><span class="n">provider</span><span class="p">).</span><span class="n">DisplayName</span><span class="p">;</span>
        <span class="n">ViewBag</span><span class="p">.</span><span class="n">ReturnUrl</span> <span class="p">=</span> <span class="n">returnUrl</span><span class="p">;</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>

<p>See the <a href="https://github.com/lyphtec/MongoSimpleMembership/tree/master/src/LyphTEC.MongoSimpleMembership.Sample">sample MVC4 app</a> for reference.   </p>
</li>
</ul><h2>Customising the storage collection names</h2>

<p>By default, the persisted <a href="https://github.com/lyphtec/MongoSimpleMembership/tree/master/src/LyphTEC.MongoSimpleMembership/Models">entities</a> are stored in collections with the following names:</p>

<p><img src="http://static.lyphtec.com/projects/msm/default_collections.png" alt="Default collection names"></p>

<p>This matches the table names used in the standard SQL Server based SimpleMembershipProvider.</p>

<p>If desired, you can change the default collection names by using the following appSettings:</p>

<div class="highlight"><pre>  <span class="nt">&lt;appSettings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"MongoSimpleMembership:MembershipAccountName"</span> <span class="na">value=</span><span class="s">"webpages_Membership"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"MongoSimpleMembership:OAuthMembershipName"</span> <span class="na">value=</span><span class="s">"webpages_OAuthMembership"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"MongoSimpleMembership:OAuthTokenName"</span> <span class="na">value=</span><span class="s">"webpages_OAuthToken"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"MongoSimpleMembership:RoleName"</span> <span class="na">value=</span><span class="s">"webpages_Role"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/appSettings&gt;</span>
</pre></div>

<h2>License</h2>

<p><a href="https://github.com/lyphtec/MongoSimpleMembership/blob/master/license.txt">Apache License, Version 2.0</a></p>
      </section>

<h2>Discussions</h2>
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'mongosimplemembership'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-2048899-5");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>